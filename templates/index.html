<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BiaTrack - Calculadora de Traslados</title>

  <!-- Montserrat (Tipograf√≠a secundaria del manual) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config (colores/gradientes de marca Bia) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bia: {
              blue:  "#001035", // Azul Bia
              purple:"#472BEF", // Morado Bia
              aqua:  "#08DDBC", // Aqua Green
              gray:  "#525A72", // Gris medio
              lilac: "#DEDEF9", // Lila claro
              ink:   "#070418", // Dark base (del set de gradientes)
              surface:"#0F133B" // apoyo oscuro
            }
          },
          fontFamily: {
            bia: ["Montserrat", "system-ui", "sans-serif"]
          },
          backgroundImage: {
            "bia-grad": "linear-gradient(135deg, #070418 0%, #3922BF 50%, #472BEF 100%)",
            "bia-aqua": "linear-gradient(135deg, #08DDBC 0%, #51EDD2 100%)"
          },
          boxShadow: {
            glow: "0 0 0 1px rgba(255,255,255,0.06), 0 18px 60px rgba(71,43,239,0.25)"
          },
          borderRadius: {
            xxl: "22px"
          }
        }
      }
    }
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; }
    body {
      font-family: Montserrat, system-ui, sans-serif;
      background: #070418;
      color: #fff;
    }
    #map { height: 520px; border-radius: 22px; }
    .custom-marker { background: transparent; border: none; }
    .custom-marker-toll { background: transparent; border: none; }
    .autocomplete-dropdown {
      position: absolute;
      z-index: 1000;
      background: #0F133B;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      margin-top: 0.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .autocomplete-item {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: background 0.2s;
    }
    .autocomplete-item:hover {
      background: rgba(71,43,239,0.2);
    }
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    ::-webkit-scrollbar { height: 10px; width: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.12); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,.05); }
    </style>
</head>

<body class="min-h-screen">
  <!-- Background glow -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute -top-32 -left-32 h-96 w-96 rounded-full blur-3xl opacity-30 bg-bia-purple"></div>
    <div class="absolute top-1/3 -right-40 h-[32rem] w-[32rem] rounded-full blur-3xl opacity-20 bg-bia-aqua"></div>
    <div class="absolute inset-0 bg-bia-ink"></div>
  </div>

        <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-white/10 bg-bia-ink/60 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-bia-aqua flex items-center justify-center text-bia-ink font-extrabold">‚ö°</div>
                <div>
          <div class="text-lg font-extrabold tracking-tight">BiaTrack</div>
          <div class="text-xs text-white/60">Calculadora de traslados - Categor√≠a I, Colombia</div>
        </div>
                </div>

      <div class="flex items-center gap-2">
        <span class="hidden sm:inline text-xs text-white/60">OSRM + Nominatim + Leaflet</span>
        <button
          onclick="toggleForm()"
          class="rounded-xl px-3 py-2 text-sm border border-white/15 hover:bg-white/10 transition"
          type="button"
        >
          <span id="toggleBtnText">Ocultar formulario</span>
                    </button>
        <button
          onclick="exportCSV()"
          class="rounded-xl px-3 py-2 text-sm border border-white/15 hover:bg-white/10 transition"
          {% if not trips %}disabled{% endif %}
          type="button"
        >
                        Descargar CSV
                    </button>
                </div>
            </div>
        </header>

  <!-- Content -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 py-6 grid gap-6 lg:grid-cols-[420px_1fr]">
    <!-- Left Panel: Formulario -->
    <section id="formSection" class="rounded-xxl border border-white/10 bg-white/5 shadow-glow overflow-hidden">
      <div class="p-5 bg-bia-grad">
        <h2 class="text-xl font-extrabold">Calculadora de Ruta</h2>
        <p class="text-sm text-white/80 mt-1">
          Selecciona contratista/unidad, ingresa destino, km/lt y COP/lt, luego calcula la ruta.
        </p>
      </div>

      <form id="tripForm" class="p-5 space-y-4" onsubmit="event.preventDefault();">
        <div id="errorContainer" class="hidden rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-300">
          <p class="font-semibold">Revisa los campos:</p>
          <ul id="errorList" class="list-disc pl-5"></ul>
        </div>

        <div class="grid grid-cols-2 gap-3">
                    <div>
            <label class="text-xs text-white/70">Contratista</label>
            <select id="contractorId" class="mt-1 w-full rounded-xl bg-bia-surface/60 border border-white/10 px-3 py-2 text-sm text-white outline-none focus:ring-2 focus:ring-bia-aqua/40" required onchange="updateBases()">
                            <option value="">Selecciona</option>
              {% for contractor in contractors %}
              <option value="{{ contractor.id }}">{{ contractor.name }}</option>
              {% endfor %}
                        </select>
                    </div>
                    <div>
            <label class="text-xs text-white/70">Base / Unidad</label>
            <select id="baseId" class="mt-1 w-full rounded-xl bg-bia-surface/60 border border-white/10 px-3 py-2 text-sm text-white outline-none focus:ring-2 focus:ring-bia-aqua/40" required onchange="updateOrigin()">
                            <option value="">Selecciona</option>
                        </select>
                    </div>
                </div>

                    <div>
          <label class="text-xs text-white/70">Origen (ciudad)</label>
          <input type="text" id="originCity" readonly class="mt-1 w-full rounded-xl bg-bia-surface/40 border border-white/10 px-3 py-2 text-sm text-white/60 outline-none" placeholder="Ciudad de origen">
                    </div>

        <div class="relative">
          <label class="text-xs text-white/70">Destino</label>
          <input type="text" id="destinationText" class="mt-1 w-full rounded-xl bg-bia-surface/60 border border-white/10 px-3 py-2 text-sm text-white outline-none focus:ring-2 focus:ring-bia-aqua/40" placeholder="Ej: Barrancabermeja o Calle 123, Barrancabermeja" required autocomplete="off" oninput="buscarCiudadAutocomplete(this.value)">
          <div id="autocompleteDropdown" class="autocomplete-dropdown hidden"></div>
                </div>

        <div class="grid grid-cols-2 gap-3">
                    <div>
            <label class="text-xs text-white/70">Consumo (km/L)</label>
            <input type="number" id="kmPerLiter" min="0" step="0.1" value="{{ default_km_per_gallon }}" readonly class="mt-1 w-full rounded-xl bg-bia-surface/40 border border-white/10 px-3 py-2 text-sm text-white/60 outline-none">
                    </div>
                    <div>
            <label class="text-xs text-white/70">Precio / Litro</label>
            <input type="number" id="precioLiterCOP" min="0" step="0.01" class="mt-1 w-full rounded-xl bg-bia-surface/60 border border-white/10 px-3 py-2 text-sm text-white outline-none focus:ring-2 focus:ring-bia-aqua/40" required>
                    </div>
                </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="roundTripCheck" class="h-4 w-4 rounded border-white/20 text-bia-aqua focus:ring-bia-aqua">
          <label for="roundTripCheck" class="text-sm text-white/80">Ida y Regreso</label>
                </div>

        <div class="flex gap-3">
          <button type="button" onclick="calcularRuta(event)" class="flex-1 rounded-xl px-4 py-2 text-sm font-bold bg-bia-aqua text-bia-ink hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Calcular Ruta
          </button>
                </div>

        <!-- Resultados de c√°lculo -->
        <div id="routeResults" class="hidden space-y-3">
          <div class="rounded-xxl border border-white/10 bg-bia-surface/50 p-4">
            <h3 class="text-sm font-bold mb-3">Resultados del c√°lculo</h3>
            <div id="routeResultsContent" class="grid gap-3 grid-cols-2">
              <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
          <button type="button" onclick="guardarCalculo()" class="w-full rounded-xl px-4 py-2 text-sm font-bold bg-bia-purple text-white hover:opacity-90 transition">
                            Guardar c√°lculo
                        </button>
                </div>
            </form>
        </section>

    <!-- Right Panel: Map -->
    <section class="space-y-4">
      <div class="rounded-xxl border border-white/10 bg-white/5 shadow-glow p-3">
        <div class="mb-2 flex items-center justify-between px-2">
          <h3 class="text-sm font-bold">Mapa de Ruta con Peajes</h3>
          <div class="flex flex-wrap gap-3 text-xs text-white/60">
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
              <span>Origen</span>
            </div>
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 rounded-full bg-red-500"></div>
              <span>Destino</span>
            </div>
            <div class="flex items-center gap-1">
              <div class="w-4 h-4 rounded bg-amber-500 border-2 border-white"></div>
              <span>Peajes</span>
            </div>
          </div>
        </div>
        <div id="map"></div>
      </div>

        <!-- Dashboard -->
      <div class="rounded-xxl border border-white/10 bg-white/5 shadow-glow overflow-hidden">
        <div class="p-4 bg-bia-grad">
          <h3 class="text-sm font-bold">Dashboard de c√°lculos</h3>
          <p class="text-xs text-white/70 mt-1">Registros almacenados en base de datos</p>
        </div>
            <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-white/10 text-sm">
            <thead class="bg-white/5 text-left text-xs font-semibold uppercase tracking-wide text-white/70">
              <tr>
                <th class="px-4 py-3">Fecha</th>
                <th class="px-4 py-3">Contratista</th>
                <th class="px-4 py-3">Base</th>
                <th class="px-4 py-3">Origen</th>
                <th class="px-4 py-3">Destino</th>
                <th class="px-4 py-3">Total COP</th>
                <th class="px-4 py-3">Acciones</th>
                        </tr>
                    </thead>
            <tbody class="divide-y divide-white/10 bg-transparent">
              {% if trips %}
                {% for trip in trips %}
                <tr class="hover:bg-white/5">
                  <td class="px-4 py-3 text-white/70">{{ trip.created_at[:19].replace('T', ' ') }}</td>
                  <td class="px-4 py-3 font-medium text-white">{{ trip.contractor_name }}</td>
                  <td class="px-4 py-3 text-white/70">{{ trip.base_label }}</td>
                  <td class="px-4 py-3 text-white/70">{{ trip.origin_city }}</td>
                  <td class="px-4 py-3 text-white/70">{{ trip.destination_text }}</td>
                  <td class="px-4 py-3 font-semibold text-bia-aqua">${{ "{:,.0f}".format(trip.total_round_trip_cop) }}</td>
                  <td class="px-4 py-3">
                    <button onclick="deleteTrip('{{ trip.id }}')" class="rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-1 text-xs font-semibold text-red-300 hover:bg-red-500/20 transition">
                      Eliminar
                    </button>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td class="px-4 py-5 text-center text-white/50" colspan="7">
                    No hay c√°lculos guardados todav√≠a.
                  </td>
                        </tr>
              {% endif %}
                    </tbody>
                </table>
        </div>
            </div>
        </section>
  </main>

    <script>
    // Datos de contratistas desde el servidor
    const contractors = {{ contractors|tojson }};
    let allTolls = [];
    let selectedTolls = [];
    let filteredTolls = [];

    function toggleForm() {
      const formSection = document.getElementById('formSection');
      const btnText = document.getElementById('toggleBtnText');
      if (formSection.style.display === 'none') {
        formSection.style.display = 'block';
        btnText.textContent = 'Ocultar formulario';
      } else {
        formSection.style.display = 'none';
        btnText.textContent = 'Nuevo c√°lculo';
      }
    }

        function updateBases() {
            const contractorId = document.getElementById('contractorId').value;
            const baseSelect = document.getElementById('baseId');
            baseSelect.innerHTML = '<option value="">Selecciona</option>';
            
      if (contractorId) {
            const contractor = contractors.find(c => c.id === contractorId);
            if (contractor) {
          contractor.bases.forEach(base => {
                    const option = document.createElement('option');
            option.value = base.id;
            option.textContent = base.label;
                    baseSelect.appendChild(option);
                });
        }
            }
            updateOrigin();
        }

        function updateOrigin() {
            const contractorId = document.getElementById('contractorId').value;
            const baseId = document.getElementById('baseId').value;
            const originInput = document.getElementById('originCity');
            
      if (contractorId && baseId) {
            const contractor = contractors.find(c => c.id === contractorId);
            if (contractor) {
                const base = contractor.bases.find(b => b.id === baseId);
          if (base) {
            originInput.value = base.city;
          }
        }
            } else {
                originInput.value = '';
            }
    }

    // Variables globales para el mapa Leaflet
    let map = null;
    let routeLayer = null;
    let markers = [];

    // Inicializar mapa Leaflet
    function initMap() {
      if (!map) {
        map = L.map('map').setView([4.6097, -74.0817], 6); // Centro de Colombia
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
      }
    }

    // Autocompletar ciudades
    let autocompleteTimeout = null;
    async function buscarCiudadAutocomplete(query) {
      const dropdown = document.getElementById('autocompleteDropdown');
      
      if (query.length < 2) {
        dropdown.classList.add('hidden');
                return;
            }
            
      clearTimeout(autocompleteTimeout);
      autocompleteTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/buscar_ciudad?q=${encodeURIComponent(query)}`);
          const data = await response.json();
          
          if (data.success && data.ciudades.length > 0) {
            dropdown.innerHTML = data.ciudades.map(ciudad => {
              const fullNameEscaped = JSON.stringify(ciudad.full_name);
              const fullNameDisplay = ciudad.full_name;
              return `<div class="autocomplete-item cursor-pointer hover:bg-bia-purple/20 px-3 py-2 border-b border-white/5" onclick="seleccionarCiudad(${fullNameEscaped}, ${ciudad.lat}, ${ciudad.lon})">
                <div class="font-medium text-white">${fullNameDisplay}</div>
                ${ciudad.type ? `<div class="text-xs text-white/50">${ciudad.type}</div>` : ''}
              </div>`;
            }).join('');
            dropdown.classList.remove('hidden');
          } else {
            dropdown.classList.add('hidden');
          }
        } catch (error) {
          console.error('Error buscando ciudad:', error);
        }
      }, 300);
    }

    function seleccionarCiudad(nombreCompleto, lat, lon) {
      const destinationInput = document.getElementById('destinationText');
      destinationInput.value = nombreCompleto;
      document.getElementById('autocompleteDropdown').classList.add('hidden');
      destinationInput.dataset.lat = lat;
      destinationInput.dataset.lon = lon;
    }

    // Cerrar autocompletar al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#destinationText') && !e.target.closest('#autocompleteDropdown')) {
        document.getElementById('autocompleteDropdown').classList.add('hidden');
      }
    });

    // Calcular ruta
    let currentRouteData = null;
    async function calcularRuta(event) {
      event?.preventDefault();
      
            const origin = document.getElementById('originCity').value;
            const destination = document.getElementById('destinationText').value;
      const kmPerLiter = parseFloat(document.getElementById('kmPerLiter').value);
      const precioLiterCOP = parseFloat(document.getElementById('precioLiterCOP').value);
      const roundTrip = document.getElementById('roundTripCheck').checked;
            
            if (!origin || !destination) {
        alert('Por favor ingresa origen y destino');
        return;
      }
      
      if (!kmPerLiter || kmPerLiter <= 0) {
        alert('El rendimiento debe ser mayor a 0');
        return;
      }
      
      if (!precioLiterCOP || precioLiterCOP <= 0) {
        alert('Por favor ingresa el precio por litro (COP/lt)');
                return;
            }
            
      const calcularBtn = event?.target || document.querySelector('button[onclick*="calcularRuta"]');
      const originalText = calcularBtn?.textContent || 'Calcular Ruta';
      if (calcularBtn) {
        calcularBtn.disabled = true;
        calcularBtn.textContent = 'Calculando...';
      }
      
      try {
        const url = `/api/calcular_ruta_supply?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&km_per_liter=${kmPerLiter}&precio_liter_cop=${precioLiterCOP}&round_trip=${roundTrip}`;
        console.log('Calculando ruta:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error HTTP:', response.status, errorText);
          let errorData;
          try {
            errorData = JSON.parse(errorText);
            throw new Error(errorData.error || `Error ${response.status}`);
          } catch {
            throw new Error(`Error ${response.status}: ${errorText.substring(0, 100)}`);
          }
        }
                
                const data = await response.json();
        console.log('Respuesta recibida:', data);
        
        if (data.success) {
          currentRouteData = data;
          mostrarRutaEnMapa(data);
          mostrarResultados(data);
          document.getElementById('routeResults').classList.remove('hidden');
                } else {
          alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
        console.error('Error al calcular ruta:', error);
        alert('Error al calcular ruta: ' + error.message);
            } finally {
        if (calcularBtn) {
          calcularBtn.disabled = false;
          calcularBtn.textContent = originalText;
        }
      }
    }

    function mostrarRutaEnMapa(data) {
      initMap();
      
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (routeLayer) {
        map.removeLayer(routeLayer);
      }
      
      if (data.ida && data.ida.geometry) {
        const coordinates = data.ida.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        routeLayer = L.polyline(coordinates, { color: '#3b82f6', weight: 4 }).addTo(map);
        
        const bounds = L.latLngBounds(coordinates);
        
        if (data.ida && data.ida.origin) {
          const originIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #10b981; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });
          const originName = data.ida.origin.display_name || data.ida.origin.name;
          const originMarker = L.marker([data.ida.origin.lat, data.ida.origin.lon], { icon: originIcon })
            .addTo(map)
            .bindPopup(`<strong>Origen:</strong> ${originName}`);
          markers.push(originMarker);
          bounds.extend([data.ida.origin.lat, data.ida.origin.lon]);
        }
        
        if (data.ida && data.ida.destination) {
          const destIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });
          const destName = data.ida.destination.display_name || data.ida.destination.name;
          const destMarker = L.marker([data.ida.destination.lat, data.ida.destination.lon], { icon: destIcon })
            .addTo(map)
            .bindPopup(`<strong>Destino:</strong> ${destName}`);
          markers.push(destMarker);
          bounds.extend([data.ida.destination.lat, data.ida.destination.lon]);
        }
        
        if (data.ida && data.ida.first_toll) {
          const firstTollIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #8b5cf6; width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">1</div>',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
          });
          const firstTollMarker = L.marker([data.ida.first_toll.latitude, data.ida.first_toll.longitude], { icon: firstTollIcon })
            .addTo(map)
            .bindPopup(`<strong>Primer Peaje:</strong> ${data.ida.first_toll.name}<br>Inicio de c√°lculo de distancia`);
          markers.push(firstTollMarker);
          bounds.extend([data.ida.first_toll.latitude, data.ida.first_toll.longitude]);
        }
        
        if (data.ida.peajes && data.ida.peajes.peajes_en_ruta && data.ida.peajes.peajes_en_ruta.length > 0) {
          data.ida.peajes.peajes_en_ruta.forEach((peaje, index) => {
            const tollIcon = L.divIcon({
              className: 'custom-marker-toll',
              html: `<div style="background-color: #f59e0b; width: 20px; height: 20px; border-radius: 3px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;">‚ÇÆ</div>`,
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            });
            
            let tollLat, tollLon;
            if (peaje.latitude && peaje.longitude) {
              tollLat = peaje.latitude;
              tollLon = peaje.longitude;
            } else {
              const routePoints = coordinates;
              const position = Math.floor((index + 1) * routePoints.length / (data.ida.peajes.peajes_en_ruta.length + 1));
              const routePoint = routePoints[Math.min(position, routePoints.length - 1)];
              tollLat = routePoint[0];
              tollLon = routePoint[1];
            }
            
            const tollMarker = L.marker([tollLat, tollLon], { icon: tollIcon })
              .addTo(map)
              .bindPopup(`
                <div style="min-width: 200px;">
                  <strong style="color: #f59e0b; font-size: 14px;">‚ÇÆ ${peaje.name}</strong><br>
                  ${peaje.department ? `<span style="color: #64748b; font-size: 12px;">${peaje.department}</span><br>` : ''}
                  ${peaje.operator ? `<span style="color: #64748b; font-size: 11px;">Operador: ${peaje.operator}</span><br>` : ''}
                  ${peaje.distance_from_route_km !== null && peaje.distance_from_route_km !== undefined ? `<span style="color: #64748b; font-size: 11px;">Distancia: ${peaje.distance_from_route_km} km</span><br>` : ''}
                  <strong style="color: #059669; font-size: 16px; margin-top: 4px; display: block;">$${peaje.fare_cop.toLocaleString()} COP</strong>
                  <div style="margin-top: 8px;">
                    <a href="https://www.waze.com/ul?q=${encodeURIComponent(peaje.name + ', ' + (peaje.department || 'Colombia'))}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 11px;">üìç Ver en Waze</a> | 
                    <a href="https://www.google.com/maps/search/?api=1&query=${tollLat},${tollLon}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 11px;">üó∫Ô∏è Ver en Google Maps</a>
                  </div>
                </div>
              `);
            markers.push(tollMarker);
            bounds.extend([tollLat, tollLon]);
          });
        }
        
        map.fitBounds(bounds, { padding: [50, 50] });
      }
      
      if (data.regreso && data.regreso.geometry) {
        const returnCoordinates = data.regreso.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        L.polyline(returnCoordinates, { color: '#10b981', weight: 4, dashArray: '10, 10' }).addTo(map);
        
        if (data.regreso.peajes && data.regreso.peajes.peajes_en_ruta && data.regreso.peajes.peajes_en_ruta.length > 0) {
          data.regreso.peajes.peajes_en_ruta.forEach((peaje, index) => {
            const tollIcon = L.divIcon({
              className: 'custom-marker-toll',
              html: `<div style="background-color: #10b981; width: 20px; height: 20px; border-radius: 3px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;">‚ÇÆ</div>`,
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            });
            
            let tollLat, tollLon;
            if (peaje.latitude && peaje.longitude) {
              tollLat = peaje.latitude;
              tollLon = peaje.longitude;
            } else {
              const returnCoords = data.regreso.geometry.coordinates.map(coord => [coord[1], coord[0]]);
              const position = Math.floor((index + 1) * returnCoords.length / (data.regreso.peajes.peajes_en_ruta.length + 1));
              const routePoint = returnCoords[Math.min(position, returnCoords.length - 1)];
              tollLat = routePoint[0];
              tollLon = routePoint[1];
            }
            
            const tollMarker = L.marker([tollLat, tollLon], { icon: tollIcon })
              .addTo(map)
              .bindPopup(`
                <div style="min-width: 200px;">
                  <strong style="color: #10b981; font-size: 14px;">‚ÇÆ ${peaje.name} (Regreso)</strong><br>
                  ${peaje.department ? `<span style="color: #64748b; font-size: 12px;">${peaje.department}</span><br>` : ''}
                  <strong style="color: #059669; font-size: 16px; margin-top: 4px; display: block;">$${peaje.fare_cop.toLocaleString()} COP</strong>
                  <div style="margin-top: 8px;">
                    <a href="https://www.waze.com/ul?q=${encodeURIComponent(peaje.name + ', ' + (peaje.department || 'Colombia'))}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 11px;">üìç Ver en Waze</a> | 
                    <a href="https://www.google.com/maps/search/?api=1&query=${tollLat},${tollLon}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 11px;">üó∫Ô∏è Ver en Google Maps</a>
                        </div>
                    </div>
              `);
            markers.push(tollMarker);
          });
        }
      }
    }

    function mostrarResultados(data) {
      const container = document.getElementById('routeResultsContent');
      const ida = data.ida;
      const regreso = data.regreso;
      const total = data.total;
      
      let html = `
        ${ida.first_toll ? `
          <div class="col-span-2 rounded-xl border border-bia-purple/30 bg-bia-purple/10 p-3 mb-2">
            <p class="text-xs text-bia-lilac">
              <strong>üìç Distancia calculada desde el primer peaje:</strong> ${ida.first_toll.name} (${ida.first_toll.department || ''})
            </p>
            ${ida.distance_from_origin_km ? `
              <p class="text-xs text-white/60 mt-1">
                Distancia completa desde origen: ${ida.distance_from_origin_km} km
              </p>
            ` : ''}
          </div>
        ` : ''}
        <div class="rounded-xl bg-white/5 p-3 border border-white/10">
          <div class="text-xs text-white/60">Distancia ida${ida.first_toll ? ' (desde primer peaje)' : ''}</div>
          <div class="text-lg font-extrabold text-bia-aqua">${ida.distance_km} km</div>
        </div>
        <div class="rounded-xl bg-white/5 p-3 border border-white/10">
          <div class="text-xs text-white/60">Tiempo normal</div>
          <div class="text-lg font-extrabold text-white">${ida.duration_normal_min} min</div>
        </div>
        <div class="rounded-xl bg-white/5 p-3 border border-white/10">
          <div class="text-xs text-white/60">Tiempo hora pico</div>
          <div class="text-lg font-extrabold text-white">${ida.duration_peak_min} min</div>
        </div>
        <div class="rounded-xl bg-white/5 p-3 border border-white/10">
          <div class="text-xs text-white/60">Peajes ida</div>
          <div class="text-lg font-extrabold text-bia-aqua">${ida.peajes.count} / $${ida.peajes.costo_total_cop.toLocaleString()}</div>
        </div>
      `;
      
      if (ida.peajes.peajes_en_ruta && ida.peajes.peajes_en_ruta.length > 0) {
        html += `
          <div class="col-span-2 rounded-xl border border-bia-purple/30 bg-bia-purple/10 p-4">
            <p class="text-sm font-bold text-bia-lilac mb-2">Peajes en la ruta (${ida.peajes.count}):</p>
            <div class="space-y-1 max-h-40 overflow-y-auto">
              ${ida.peajes.peajes_en_ruta.map((peaje, index) => `
                <div class="flex justify-between items-center text-xs bg-white/5 px-2 py-1 rounded border border-white/10 ${peaje.is_exit_toll ? 'border-bia-purple/50 bg-bia-purple/20' : ''}">
                  <span class="text-white/80">
                    ${peaje.is_exit_toll ? '<span class="text-bia-lilac font-bold">üö™</span> ' : ''}
                    <strong>${peaje.name}</strong>
                    ${peaje.is_exit_toll ? ' <span class="text-bia-lilac text-xs">(Peaje de salida)</span>' : ''}
                    ${peaje.department ? ` (${peaje.department})` : ''}
                    ${peaje.distance_from_route_km !== null && peaje.distance_from_route_km !== undefined && peaje.distance_from_route_km > 0 ? ` - ${peaje.distance_from_route_km} km` : ''}
                  </span>
                  <span class="font-semibold text-bia-aqua">$${peaje.fare_cop.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      if (regreso && total) {
        html += `
          <div class="rounded-xl bg-white/5 p-3 border border-white/10">
            <div class="text-xs text-white/60">Distancia total</div>
            <div class="text-lg font-extrabold text-bia-aqua">${total.distance_km} km</div>
          </div>
          <div class="rounded-xl bg-white/5 p-3 border border-white/10">
            <div class="text-xs text-white/60">Combustible total</div>
            <div class="text-lg font-extrabold text-white">${total.combustible_liters} lt</div>
          </div>
          <div class="rounded-xl bg-white/5 p-3 border border-white/10">
            <div class="text-xs text-white/60">Costo combustible</div>
            <div class="text-lg font-extrabold text-bia-aqua">$${total.combustible_cost_cop.toLocaleString()}</div>
          </div>
          <div class="col-span-2 rounded-xl bg-bia-aqua/20 p-3 border border-bia-aqua/30">
            <div class="text-xs text-bia-aqua">Total ida y regreso</div>
            <div class="text-xl font-extrabold text-bia-aqua">$${total.total_cost_cop.toLocaleString()}</div>
          </div>
        `;
      } else {
        html += `
          <div class="rounded-xl bg-white/5 p-3 border border-white/10">
            <div class="text-xs text-white/60">Combustible ida</div>
            <div class="text-lg font-extrabold text-white">${ida.combustible.liters} lt</div>
          </div>
          <div class="rounded-xl bg-white/5 p-3 border border-white/10">
            <div class="text-xs text-white/60">Costo combustible</div>
            <div class="text-lg font-extrabold text-bia-aqua">$${ida.combustible.cost_cop.toLocaleString()}</div>
          </div>
          <div class="col-span-2 rounded-xl bg-bia-aqua/20 p-3 border border-bia-aqua/30">
            <div class="text-xs text-bia-aqua">Total ida</div>
            <div class="text-xl font-extrabold text-bia-aqua">$${ida.total_cost_cop.toLocaleString()}</div>
                </div>
            `;
        }

      container.innerHTML = html;
    }

    async function guardarCalculo() {
      if (!currentRouteData) {
        alert('Primero calcula una ruta');
        return;
      }
      
      const tripData = {
        contractor_name: contractors.find(c => c.id === document.getElementById('contractorId').value)?.name || '',
        base_label: contractors.find(c => c.id === document.getElementById('contractorId').value)?.bases.find(b => b.id === document.getElementById('baseId').value)?.label || '',
        origin_city: document.getElementById('originCity').value,
        destination_text: document.getElementById('destinationText').value,
        fuel_type: 'GASOLINA',
        fuel_price_per_gallon_cop: parseFloat(document.getElementById('precioLiterCOP').value) * 3.78541,
        km_per_gallon: parseFloat(document.getElementById('kmPerLiter').value) * 3.78541,
        one_way_distance_km: currentRouteData.ida.distance_km,
        one_way_eta_minutes: currentRouteData.ida.duration_normal_min,
        toll_count_one_way: currentRouteData.ida.peajes.count,
        toll_cost_one_way_cop: currentRouteData.ida.peajes.costo_total_cop
            };
            
            try {
        const response = await fetch('/api/trip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tripData)
        });
        
        const data = await response.json();
        
        if (data.success) {
                alert('C√°lculo guardado exitosamente');
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
            } catch (error) {
        alert('Error al guardar: ' + error.message);
      }
    }

    async function deleteTrip(tripId) {
      if (!confirm('¬øEst√°s seguro de eliminar este c√°lculo?')) {
                return;
            }
            
      try {
        const response = await fetch(`/api/trip/${tripId}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.success) {
          location.reload();
                }
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        }

        function exportCSV() {
      window.location.href = '/api/trips/export';
    }

    // Inicializar mapa al cargar
    initMap();
    </script>
</body>
</html>
